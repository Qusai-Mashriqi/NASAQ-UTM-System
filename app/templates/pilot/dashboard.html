{% extends "base.html" %}

{% block content %}
<div class="row">
    
    <div class="col-md-3">
        <div class="glass-card mb-4">
            <div class="text-center">
                <i class="fas fa-user-astronaut fa-3x mb-3" style="color: var(--neon-blue);"></i>
                <h4 class="brand-font">{{ current_user.full_name }}</h4>
                <p class="text-muted small mb-1">{{ current_user.organization_type }}</p>
                <span class="badge bg-success">Active Operator</span>
            </div>
            <hr style="border-color: var(--border-color);">
            
            <div class="d-grid gap-2">
                <a href="{{ url_for('pilot.add_drone') }}" class="btn btn-nasaq btn-sm">
                    <i class="fas fa-plus-circle me-2"></i> Register New Drone
                </a>
                <a href="{{ url_for('pilot.request_flight') }}" class="btn btn-outline-light btn-sm">
                    <i class="fas fa-route me-2"></i> Request Flight Plan
                </a>
            </div>
        </div>

        <div class="glass-card mb-4">
            <h6 class="text-muted border-bottom pb-2 mb-3">
                <i class="fas fa-plane"></i> My Fleet <span class="badge bg-secondary">{{ drones|length }}</span>
            </h6>
            
            {% if drones %}
                <ul class="list-group list-group-flush bg-transparent">
                {% for drone in drones %}
                    <li class="list-group-item bg-transparent text-white border-bottom border-secondary px-0">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong style="color: var(--neon-blue);">{{ drone.name }}</strong><br>
                                <small class="text-muted" style="font-size: 0.75rem;">SN: {{ drone.serial_number }}</small>
                            </div>
                            <span class="badge bg-dark border border-secondary">{{ drone.weight }}kg</span>
                        </div>
                    </li>
                {% endfor %}
                </ul>
            {% else %}
                <div class="text-center text-muted py-3">
                    <small>No drones registered yet.</small>
                </div>
            {% endif %}
        </div>

        <div class="glass-card">
            <h6 class="text-muted border-bottom pb-2 mb-3">Map Legend</h6>
            <div class="d-flex align-items-center mb-2">
                <span style="width: 15px; height: 15px; background: #ff2a6d; display: inline-block; margin-right: 10px;"></span>
                <small>No-Fly Zone</small>
            </div>
            <div class="d-flex align-items-center mb-2">
                <span style="width: 15px; height: 15px; background: #ffc107; display: inline-block; margin-right: 10px;"></span>
                <small>Restricted Zone</small>
            </div>
            <div class="d-flex align-items-center">
                <span style="width: 15px; height: 15px; background: #00f0b5; display: inline-block; margin-right: 10px;"></span>
                <small>Safe Zone</small>
            </div>
        </div>
    </div>

    <div class="col-md-9">
        
        <div class="glass-card p-0 mb-4" style="height: 500px; overflow: hidden; position: relative;">
            <div id="map" style="width: 100%; height: 100%;"></div>
            <div style="position: absolute; top: 10px; right: 10px; z-index: 999; background: rgba(0,0,0,0.7); padding: 10px; border-radius: 5px; border: 1px solid var(--neon-blue);">
                <small style="color: var(--neon-blue); font-family: 'Orbitron';">LIVE AIRSPACE VIEW</small>
            </div>
        </div>

        <div class="glass-card">
            <h5 class="brand-font mb-3 text-warning"><i class="fas fa-clipboard-list"></i> Flight Request Log</h5>
            <div class="table-responsive">
                <table class="table table-dark table-hover align-middle mb-0" style="background: transparent;">
                    <thead>
                        <tr style="border-color: var(--neon-blue);">
                            <th>ID</th>
                            <th>Drone</th>
                            <th>Start Time</th>
                            <th>Duration</th>
                            <th>Max Alt</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for flight in flights %}
                        <tr>
                            <td><span class="text-muted">#{{ flight.id }}</span></td>
                            <td>{{ flight.drone.name }}</td>
                            <td>{{ flight.start_time.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td>
                                {% set duration = (flight.end_time - flight.start_time).seconds // 60 %}
                                {{ duration }} min
                            </td>
                            <td>{{ flight.max_altitude }}m</td>
                            <td>
                                {% if flight.status == 'pending' %}
                                    <span class="badge bg-warning text-dark"><i class="fas fa-clock"></i> PENDING</span>
                                {% elif flight.status == 'approved' %}
                                    <a href="{{ url_for('pilot.simulate_flight', flight_id=flight.id) }}" class="btn btn-success btn-sm animate-pulse">
                                        <i class="fas fa-play"></i> START MISSION
                                    </a>
                                {% else %}
                                    <span class="badge bg-danger"><i class="fas fa-times-circle"></i> REJECTED</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="6" class="text-center text-muted py-4">
                                No flight requests submitted yet.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</div>
{% endblock %}


{% block scripts %}
<script>
    // 1. إعداد الخريطة
    var map = L.map('map').setView([31.95, 35.91], 11);

    var isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    var tileUrl = isDark ? 
        'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png' : 
        'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png';
        
    var tileLayer = L.tileLayer(tileUrl, {
        attribution: '&copy; OpenStreetMap &copy; CARTO',
        maxZoom: 20
    }).addTo(map);

    function updateMapTile(theme) {
        var newUrl = theme === 'dark' ? 
            'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png' : 
            'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png';
        tileLayer.setUrl(newUrl);
    }

    // 2. جلب ورسم المناطق (تم التعديل ليدعم الدوائر والمضلعات)
    fetch('/pilot/get_operational_zones')
    .then(res => res.json())
    .then(data => {
        data.forEach(zone => {
            var color = zone.type === 'red' ? '#ff2a6d' : (zone.type === 'yellow' ? '#ffc107' : '#00f0b5');
            var coords = zone.coords;

            // حماية من البيانات النصية
            if (typeof coords === 'string') {
                try { coords = JSON.parse(coords); } catch(e) {}
            }

            try {
                // الفحص: هل هي دائرة؟ (تحتوي على radius)
                if (coords.type === 'circle' || (coords.lat && coords.radius)) {
                    L.circle([coords.lat, coords.lng], {
                        radius: coords.radius,
                        color: color,
                        fillOpacity: 0.2,
                        weight: 1
                    }).addTo(map).bindPopup(`
                        <div class="text-center">
                            <strong style="color:${color}">${zone.name}</strong><br>
                            <span class="badge bg-secondary">${zone.type.toUpperCase()} ZONE</span>
                        </div>
                    `);
                } 
                // إذن هي مضلع
                else {
                    L.polygon(coords, {
                        color: color, 
                        fillOpacity: 0.2,
                        weight: 1
                    }).addTo(map).bindPopup(`
                        <div class="text-center">
                            <strong style="color:${color}">${zone.name}</strong><br>
                            <span class="badge bg-secondary">${zone.type.toUpperCase()} ZONE</span>
                        </div>
                    `);
                }
            } catch(e) { console.log("Error drawing zone:", e); }
        });
    });
</script>
{% endblock %}