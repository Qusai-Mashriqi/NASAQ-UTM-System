{% extends "base.html" %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>

<div class="row">
    <div class="col-md-4">
        <div class="glass-card h-100">
            <h4 class="brand-font mb-4 text-warning"><i class="fas fa-drafting-compass"></i> New Flight Plan</h4>
            
            <form method="POST" id="flightForm">
                <div class="mb-3">
                    <label class="text-muted small">Select Drone</label>
                    <select name="drone_id" class="form-control bg-dark text-white" required>
                        {% for drone in drones %}
                            <option value="{{ drone.id }}">{{ drone.name }} ({{ drone.weight }}kg)</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="row">
                    <div class="col-6 mb-3">
                        <label class="text-muted small">Start Time</label>
                        <input type="datetime-local" name="start_time" class="form-control" required>
                    </div>
                    <div class="col-6 mb-3">
                        <label class="text-muted small">End Time</label>
                        <input type="datetime-local" name="end_time" class="form-control" required>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="text-muted small">Max Altitude (meters)</label>
                    <input type="number" name="max_altitude" class="form-control" placeholder="e.g. 120" max="400" required>
                    <small class="text-muted" style="font-size: 0.7em;">Max allowed: 120m (AGL)</small>
                </div>

                <input type="hidden" name="path_coords" id="pathCoordsInput">

                <hr>
                <div class="alert alert-info small">
                    <i class="fas fa-info-circle"></i> Use the map tools to draw your flight path. Ensure you avoid Red Zones.
                </div>

                <button type="submit" class="btn btn-nasaq w-100" id="submitBtn" disabled>
                    Submit Plan
                </button>
            </form>
        </div>
    </div>

    <div class="col-md-8">
        <div class="glass-card p-0" style="height: 600px; position: relative;">
            <div id="map" style="width: 100%; height: 100%;"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
<script>
    // 1. إعداد الخريطة
    var map = L.map('map').setView([31.95, 35.91], 12);
    
    var isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    var tileUrl = isDark ? 
        'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png' : 
        'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png';
    L.tileLayer(tileUrl, { maxZoom: 20 }).addTo(map);

    // 2. تحميل المناطق المحظورة (عشان الطيار يشوفها)
    fetch('/pilot/get_operational_zones')
    .then(res => res.json())
    .then(data => {
        data.forEach(zone => {
            var color = zone.type === 'red' ? '#ff2a6d' : (zone.type === 'yellow' ? '#ffc107' : '#00f0b5');
            L.polygon(zone.coords, {color: color, fillOpacity: 0.2, weight: 1}).addTo(map);
        });
    });

    // 3. أدوات الرسم (فقط خطوط Polylines)
    var drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    var drawControl = new L.Control.Draw({
        edit: { featureGroup: drawnItems },
        draw: {
            polygon: false, rectangle: false, circle: false, 
            marker: false, circlemarker: false,
            polyline: {
                shapeOptions: { color: '#00d4ff', weight: 4 }
            }
        }
    });
    map.addControl(drawControl);

    // 4. عند الانتهاء من الرسم
    map.on(L.Draw.Event.CREATED, function (e) {
        // حذف أي رسمة سابقة (نسمح بمسار واحد فقط)
        drawnItems.clearLayers();
        
        var layer = e.layer;
        drawnItems.addLayer(layer);
        
        // استخراج الإحداثيات وتخزينها في الحقل المخفي
        var coords = layer.getLatLngs();
        var jsonCoords = JSON.stringify(coords);
        document.getElementById('pathCoordsInput').value = jsonCoords;
        
        // تفعيل زر الإرسال
        document.getElementById('submitBtn').disabled = false;
        document.getElementById('submitBtn').innerHTML = '<i class="fas fa-paper-plane"></i> Submit Plan';
    });

    // عند حذف الرسمة
    map.on(L.Draw.Event.DELETED, function() {
        document.getElementById('submitBtn').disabled = true;
        document.getElementById('pathCoordsInput').value = '';
    });
</script>
{% endblock %}