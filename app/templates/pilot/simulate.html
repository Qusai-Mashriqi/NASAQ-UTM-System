{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-3">
        <div class="glass-card h-100 text-center">
            <h4 class="brand-font text-info mb-4">Mission Control</h4>
            
            <div class="mb-4">
                <div id="radar-anim">
                    <i class="fas fa-satellite-dish fa-3x mb-2" style="color: var(--neon-green);"></i>
                </div>
                <h5 class="mt-2">Live Tracking</h5>
                <span id="signal-status" class="badge bg-success animate-blink">SIGNAL: STRONG</span>
            </div>

            <hr>
            
            <div class="text-start px-3">
                <p class="mb-1 text-muted small">Drone Model:</p>
                <p class="fw-bold text-white">{{ flight.drone.name }}</p>
                
                <div class="row mt-3">
                    <div class="col-6">
                        <p class="mb-1 text-muted small">Altitude (AGL):</p>
                        <p class="fw-bold text-warning" id="alt-display">0.0 m</p>
                    </div>
                    <div class="col-6">
                        <p class="mb-1 text-muted small">Ground Speed:</p>
                        <p class="fw-bold text-info" id="speed-display">0.0 km/h</p>
                    </div>
                </div>

                <div class="mt-3">
                    <p class="mb-1 text-muted small">Mission Timer:</p>
                    <p class="fw-bold" style="font-family: monospace; font-size: 1.2rem;" id="timer-display">00:00</p>
                </div>
            </div>

            <hr>
            <button onclick="abortMission()" class="btn btn-outline-danger w-100">
                <i class="fas fa-ban"></i> ABORT MISSION
            </button>
        </div>
    </div>

    <div class="col-md-9">
        <div class="glass-card p-0" style="height: 600px; position: relative;">
            <div id="map" style="width: 100%; height: 100%;"></div>
            
            <div class="progress" style="height: 5px; position: absolute; bottom: 0; width: 100%; z-index: 999;">
                <div id="flight-progress" class="progress-bar bg-success" style="width: 0%; transition: none;"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="successModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content glass-card" style="border: 2px solid var(--neon-green); text-align: center;">
            <div class="modal-body py-5">
                <i class="fas fa-check-circle fa-5x text-success mb-3 animate-pulse"></i>
                <h2 class="brand-font text-white">Mission Accomplished</h2>
                <p class="text-muted">The drone has reached the destination safely.</p>
                <div class="mt-4">
                    <a href="{{ url_for('pilot.dashboard') }}" class="btn btn-nasaq px-5">Return to Base</a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .animate-pulse { animation: pulse 2s infinite; }
    .animate-blink { animation: blink 1s infinite; }
    
    @keyframes pulse {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.1); opacity: 0.7; }
        100% { transform: scale(1); opacity: 1; }
    }
    @keyframes blink { 50% { opacity: 0; } }

    /* أيقونة الدرون المخصصة */
    .drone-marker {
        transition: all 0.1s linear; /* حركة ناعمة */
    }
    .drone-svg {
        filter: drop-shadow(0px 0px 5px #00d4ff);
        animation: hoverDrone 1s infinite alternate ease-in-out;
    }
    @keyframes hoverDrone {
        from { transform: translateY(0); }
        to { transform: translateY(-3px); }
    }
</style>
{% endblock %}



{% block scripts %}
<script>
    var map = L.map('map').setView([31.95, 35.91], 13);
    var isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    var tileUrl = isDark ? 
        'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png' : 
        'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png';
    L.tileLayer(tileUrl, { maxZoom: 20 }).addTo(map);

    // ======================
    // كود عرض المناطق الموحد
    // ======================
    fetch('/pilot/get_operational_zones')
    .then(res => res.json())
    .then(data => {
        data.forEach(zone => {
            var color = zone.type === 'red' ? '#ff2a6d' : (zone.type === 'yellow' ? '#ffc107' : '#00f0b5');
            var coords = zone.coords;

            if (typeof coords === 'string') {
                try { coords = JSON.parse(coords); } catch(e) {}
            }

            try {
                // الكشف عن الدائرة (بالطريقة الجديدة أو القديمة)
                if (coords.type === 'circle' || (coords.lat && coords.radius)) {
                    L.circle([coords.lat, coords.lng], {
                        radius: coords.radius,
                        color: color,
                        fillOpacity: 0.2,
                        weight: 1
                    }).addTo(map);
                } else {
                    L.polygon(coords, {
                        color: color, 
                        fillOpacity: 0.2, 
                        weight: 1
                    }).addTo(map);
                }
            } catch(e) { console.error(e); }
        });
    });

    // ======================
    // كود المحاكاة (زي ما هو)
    // ======================
    var rawPathData = '{{ flight.path_data | safe }}';
    var maxAllowedAlt = Number("{{ flight.max_altitude }}"); 
    var simulationDuration = 15000; 
    var animationFrameId;
    var startTime = null;

    try {
        var pathData = JSON.parse(rawPathData);
        if (pathData && pathData.length > 0) {
            
            var polyline = L.polyline(pathData, {color: 'rgba(0, 212, 255, 0.4)', weight: 3, dashArray: '5, 10'}).addTo(map);
            map.fitBounds(polyline.getBounds(), {padding: [80, 80]});

            var droneIconHtml = `<svg class="drone-svg" viewBox="0 0 512 512" width="40" height="40" fill="#00d4ff" xmlns="http://www.w3.org/2000/svg"><path d="M448 64c-17.7 0-32 14.3-32 32v32h-48V80c0-26.5-21.5-48-48-48s-48 21.5-48 48v48H240V80c0-26.5-21.5-48-48-48s-48 21.5-48 48v48H96V96c0-17.7-14.3-32-32-32S32 78.3 32 96v32c0 17.7 14.3 32 32 32h48v48c-26.5 0-48 21.5-48 48s21.5 48 48 48v48H64c-17.7 0-32 14.3-32 32s14.3 32 32 32v32c0 17.7 14.3 32 32 32s32-14.3 32-32v-32h48v48c0 26.5 21.5 48 48 48s48-21.5 48-48v-48h48v48c0 26.5 21.5 48 48 48s48-21.5 48-48v-48h48v32c0 17.7 14.3 32 32 32s32-14.3 32-32v-32c0-17.7-14.3-32-32-32h-48v-48c26.5 0 48-21.5 48-48s-21.5-48-48-48v-48h48v32c0 17.7 14.3 32 32 32s32-14.3 32-32V96c0-17.7-14.3-32-32-32zM192 192a64 64 0 1 1 128 0 64 64 0 1 1 -128 0z"/></svg>`;
            var droneIcon = L.divIcon({ className: 'drone-marker', html: droneIconHtml, iconSize: [40, 40], iconAnchor: [20, 20] });
            var marker = L.marker(pathData[0], {icon: droneIcon}).addTo(map);

            var totalDistance = 0;
            for(let i=0; i<pathData.length-1; i++) totalDistance += map.distance(pathData[i], pathData[i+1]);

            function getPointAtPercent(percent) {
                var targetDist = totalDistance * percent;
                var currentDist = 0;
                for(let i=0; i<pathData.length-1; i++) {
                    var segmentDist = map.distance(pathData[i], pathData[i+1]);
                    if (currentDist + segmentDist >= targetDist) {
                        var segmentPercent = (targetDist - currentDist) / segmentDist;
                        var lat = pathData[i].lat + (pathData[i+1].lat - pathData[i].lat) * segmentPercent;
                        var lng = pathData[i].lng + (pathData[i+1].lng - pathData[i].lng) * segmentPercent;
                        return [lat, lng];
                    }
                    currentDist += segmentDist;
                }
                return pathData[pathData.length - 1];
            }

            function animate(timestamp) {
                if (!startTime) startTime = timestamp;
                var elapsed = timestamp - startTime;
                var progress = elapsed / simulationDuration;

                if (progress < 1) {
                    var newLatLng = getPointAtPercent(progress);
                    marker.setLatLng(newLatLng);
                    document.getElementById('flight-progress').style.width = (progress * 100) + '%';
                    document.getElementById('timer-display').innerText = "00:" + String(Math.floor(elapsed / 1000)).padStart(2, '0');
                    
                    var simulatedAlt = (maxAllowedAlt * 0.8) + (Math.sin(elapsed / 1000) * 5);
                    if(simulatedAlt > maxAllowedAlt) simulatedAlt = maxAllowedAlt;
                    document.getElementById('alt-display').innerText = simulatedAlt.toFixed(1) + ' m';

                    var simulatedSpeed = 25 + (Math.random() * 5) - 2.5; 
                    if(simulatedSpeed > 30) simulatedSpeed = 30.0;
                    document.getElementById('speed-display').innerText = simulatedSpeed.toFixed(1) + ' km/h';

                    animationFrameId = requestAnimationFrame(animate);
                } else {
                    marker.setLatLng(pathData[pathData.length - 1]);
                    document.getElementById('flight-progress').style.width = '100%';
                    document.getElementById('timer-display').innerText = "00:15";
                    document.getElementById('speed-display').innerText = "0.0 km/h";
                    var successModal = new bootstrap.Modal(document.getElementById('successModal'));
                    successModal.show();
                }
            }
            requestAnimationFrame(animate);
        }
    } catch(e) { console.error(e); }

    function abortMission() {
        cancelAnimationFrame(animationFrameId);
        document.getElementById('signal-status').className = "badge bg-danger";
        document.getElementById('signal-status').innerText = "SIGNAL: LOST";
        document.querySelector('.drone-svg').style.fill = 'red';
        alert("MISSION ABORTED BY PILOT.");
    }
</script>
{% endblock %}